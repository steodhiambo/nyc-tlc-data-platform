{{ define "smtp_auth_username" }}{{ .ExternalURL | reReplaceAll ".*//" "" | reReplaceAll "/.*" "" | reReplaceAll ":.*" "" }}{{ end }}
{{ define "smtp_auth_password" }}{{ .ExternalURL | reReplaceAll ".*//" "" | reReplaceAll "/.*" "" | reReplaceAll ".*:" "" }}{{ end }}
{{ define "slack_api_url" }}{{ .ExternalURL | reReplaceAll ".*//" "" | reReplaceAll "/.*" "" }}{{ end }}

{{ define "nyc_tlc_notification.html" }}
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>NYC TLC Data Platform Alert</title>
  <style>
    body { font-family: Arial, sans-serif; }
    .header { background-color: #f4f4f4; padding: 10px; }
    .alert { border: 1px solid #ddd; margin: 10px 0; padding: 10px; }
    .critical { background-color: #ffebee; border-left: 5px solid #f44336; }
    .warning { background-color: #fff3e0; border-left: 5px solid #ff9800; }
    .info { background-color: #e3f2fd; border-left: 5px solid #2196f3; }
    table { border-collapse: collapse; width: 100%; }
    th, td { text-align: left; padding: 8px; border: 1px solid #ddd; }
    th { background-color: #f2f2f2; }
  </style>
</head>
<body>
  <div class="header">
    <h2>NYC TLC Data Platform Alert</h2>
    <p><strong>Time:</strong> {{ .Date }}</p>
  </div>
  
  {{ range .Alerts }}
  <div class="alert {{ .Labels.severity }}">
    <h3>{{ .Labels.alertname }}</h3>
    <p><strong>Severity:</strong> {{ .Labels.severity }}</p>
    <p><strong>Summary:</strong> {{ .Annotations.summary }}</p>
    <p><strong>Description:</strong> {{ .Annotations.description }}</p>
    
    <h4>Labels:</h4>
    <table>
      <tr><th>Label</th><th>Value</th></tr>
      {{ range .Labels.SortedPairs }}
      <tr><td>{{ .Name }}</td><td>{{ .Value }}</td></tr>
      {{ end }}
    </table>
  </div>
  {{ end }}
  
  <hr>
  <p><em>This alert was generated by the NYC TLC Data Platform monitoring system.</em></p>
</body>
</html>
{{ end }}

{{ define "nyc_tlc_slack_notification" }}
{
  "attachments": [
    {
      "color": "{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}",
      "title": "{{ .CommonLabels.alertname }}",
      "text": "{{ .CommonAnnotations.summary }}",
      "fields": [
        {
          "title": "Severity",
          "value": "{{ .CommonLabels.severity }}",
          "short": true
        },
        {
          "title": "Status",
          "value": "{{ .Status }}",
          "short": true
        }
        {{ range .Alerts }}
        {{ range .Labels.SortedPairs }}
        ,{
          "title": "{{ .Name }}",
          "value": "{{ .Value }}",
          "short": true
        }
        {{ end }}
        {{ end }}
      ],
      "footer": "NYC TLC Data Platform",
      "footer_icon": "https://platform.example.com/logo.png",
      "ts": {{ .Alerts.Firing | len }}
    }
  ]
}
{{ end }}